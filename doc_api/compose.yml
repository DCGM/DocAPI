services:
  doc-api:
    # see https://github.com/DCGM/DocAPI/pkgs/container/doc-api and choose your version
    image: ghcr.io/dcgm/doc-api:latest
    # for local build from GIT
    # build:
    #   context: path/to/doc/api/root/git/DocAPI/doc_api
    #   dockerfile: Dockerfile
    ports:
      - "9999:9999"
    volumes:
      - /mnt/zfs1/doc_api/doc_api_data:/app/doc_api_data
    env_file:
      - .env
    environment:
      # Job definition examples for documentation (validation is strictly for JobDefinition schema)
      JOB_DEFINITION_SUMMARY: |
        Create Job
      JOB_DEFINITION_DESCRIPTION: |
        Create a new job with the specified images and options.

        The job definition must include a list of `images`, each with a unique `name` and `order`.

        If ALTO XML, PAGE XML and Meta JSON files are required, the respective flags `alto_required`,
        `page_required`, `meta_json_required` must be set to `true`.

        The images must have specified extensions (e.g., `.jpg`, `.png`) in their names.

        Do not use `alto_required` together with `page_required`, unless your processing worker supports both formats.
        
        Optionally, you can specify `engine_name` to select a specific processing engine. Default engine will be used if not specified.
      JOB_DEFINITION_EXAMPLES: |
        {
          "IMAGE job": {
            "summary": "Default",
            "description": "Simple job with two images.",
            "value": {
              "images": [
                { "name": "image0.jpg", "order": 0 },
                { "name": "image1.jpg", "order": 1 }
              ],
              "meta_json_required": false,
              "alto_required": false,
              "page_required": false,
              "engine_name": "Engine A"
            }
          }
        }
      # Meta JSON upload examples for documentation (validation is done only for valid JSON structure, not content)
      META_JSON_SUMMARY: |
        Upload Meta JSON
      META_JSON_DESCRIPTION: |
        Upload the Meta JSON file for a job.
      META_JSON_EXAMPLES: |
        {
          "object": {"summary": "JSON object", "value": {"engine": "ocr", "version": 2}},
          "array": {"summary": "JSON array", "value": ["step1", "step2", "step3"]},
          "primitive": {"summary": "Primitive value", "value": true}
        }
      # Result download examples for documentation
      RESULT_SUMMARY: |
        Download Result
      RESULT_DESCRIPTION: |
        Download the result ZIP file for a completed job.
      RESULT_EXAMPLE: |
        (binary ZIP file content)
    restart: unless-stopped
    # if using traefik, comment out the ports section above and uncomment the labels section below (add traefik network)
    # labels:
    #   - traefik.enable=true
    #   - traefik.http.routers.doc-api.rule=Host(`doc-api.com`)
    #   - traefik.http.routers.doc-api.entrypoints=websecure
    #   - traefik.http.services.doc-api.loadbalancer.server.port=9999
    depends_on:
      db:
        condition: service_healthy
    networks: [ doc_api_network ]


  db:
    image: postgres:16
    volumes:
      - /mnt/ssd/doc_api/db:/var/lib/postgresql/data/
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -q -d ${POSTGRES_DB:-postgres} -U ${POSTGRES_USER:-postgres}"]
      timeout: 45s
      interval: 5s
      retries: 20
    shm_size: 1g
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks: [ doc_api_network ]


  db-backup:
    image: prodrigestivill/postgres-backup-local
    volumes:
      - /mnt/zfs1/doc_api/db_backup:/backups
    expose:
      - 8001
    env_file:
      - .env
    environment:
      POSTGRES_HOST: db
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: "0 0 * * *"   # daily 00:00
      BACKUP_KEEP_DAYS: "7"
      BACKUP_KEEP_WEEKS: "4"
      BACKUP_KEEP_MONTHS: "6"
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    networks: [doc_api_network]


networks:
  doc_api_network: {}

